<div class="page-shell customer-detail">
  <div class="page-header items-center">
    @if (loadingCustomer) {
      <div>
        <app-ui-skeleton width="200px" height="30px"></app-ui-skeleton>
        <div class="mt-2">
          <app-ui-skeleton width="240px" height="15px"></app-ui-skeleton>
        </div>
      </div>
      <div class="page-header-actions">
        <app-ui-skeleton width="90px" height="34px" radius="14px"></app-ui-skeleton>
        <app-ui-skeleton width="90px" height="34px" radius="14px"></app-ui-skeleton>
      </div>
    } @else {
      <div>
        <h1 class="page-title">{{ 'customerDetail.title' | translate }}</h1>
        <p class="page-subtitle">{{ 'customerDetail.subtitle' | translate }}</p>
      </div>

      <div class="page-header-actions">
        <app-ui-button variant="ghost" type="button" (click)="back()">
          <i class="ri-arrow-left-line ui-button__icon" aria-hidden="true"></i>
          {{ 'common.back' | translate }}
        </app-ui-button>
        <app-ui-button type="button" (click)="edit()">
          <i class="ri-pencil-line ui-button__icon" aria-hidden="true"></i>
          {{ 'common.edit' | translate }}
        </app-ui-button>
        <app-ui-button variant="danger" type="button" (click)="openDelete()">
          <i class="ri-delete-bin-6-line ui-button__icon" aria-hidden="true"></i>
          {{ 'common.delete' | translate }}
        </app-ui-button>
      </div>
    }
  </div>

  @if (customer; as c) {
    <div class="card detail-summary">
      <div class="detail-summary__grid">
        <div class="detail-pill">
          <div class="detail-label">{{ 'customers.name' | translate }}</div>
          <div class="detail-value">{{ c.name }}</div>
        </div>
        <div class="detail-pill">
          <div class="detail-label">{{ 'customers.email' | translate }}</div>
          <div class="detail-value">{{ c.email }}</div>
        </div>
        <div class="detail-pill">
          <div class="detail-label">{{ 'customers.phone' | translate }}</div>
          <div class="detail-value">{{ c.phone }}</div>
        </div>

        <div class="detail-pill">
          <div class="detail-label">{{ 'customers.walletNumber' | translate }}</div>
          <div class="detail-value">{{ c.walletNumber }}</div>
        </div>
        <div class="detail-pill">
          <div class="detail-label">{{ 'customers.nationalId' | translate }}</div>
          <div class="detail-value">{{ c.nationalId }}</div>
        </div>
        <div class="detail-pill detail-pill--badge">
          <div class="detail-label">{{ 'customers.kycStatus' | translate }}</div>
          <app-customer-status-badge [status]="c.kycStatus"></app-customer-status-badge>
        </div>
      </div>

      <div class="detail-summary__address">
        <div class="detail-label">{{ 'customers.address.title' | translate }}</div>
        <div class="detail-value">{{ c.address.line1 }}, {{ c.address.postalCode }} {{ c.address.city }} / {{ c.address.country }}</div>
      </div>
    </div>
  } @else {
    <div class="card detail-summary">
      <div class="detail-summary__grid">
        @for (i of [1,2,3,4,5,6]; track i) {
          <div class="detail-pill detail-pill--skeleton">
            <app-ui-skeleton width="90px" height="11px"></app-ui-skeleton>
            <app-ui-skeleton height="16px"></app-ui-skeleton>
          </div>
        }
      </div>
      <div class="detail-summary__address detail-summary__address--skeleton">
        <app-ui-skeleton width="120px" height="11px"></app-ui-skeleton>
        <app-ui-skeleton height="20px"></app-ui-skeleton>
      </div>
    </div>
  }

  <div class="detail-split">
    <div class="card">
      <div class="card-title">{{ 'wallet.title' | translate }}</div>
      <div class="card-sub">{{ 'wallet.subtitle' | translate }}</div>

      @if (wallet; as w) {
        <div class="wallet">
          <div class="balance">
            <div class="detail-label">{{ 'wallet.balance' | translate }}</div>
            <div class="detail-value">{{ w.balance | number:'1.2-2' }} {{ w.currency }}</div>
          </div>

          <div class="limits">
            <app-ui-form
              #limitsFormRef
              [fields]="limitFields"
              [initialValue]="limitsInitialValue"
              [formValidators]="limitFormValidators"
              [preventSubmit]="true"
              [showSubmit]="false"
              formClass="filters-grid"
            ></app-ui-form>

            @if (limitsFormRef?.form?.errors?.['limitMismatch'] && (limitsFormRef.form.dirty || limitsFormRef.form.touched)) {
              <div class="err">{{ 'validation.limitMismatch' | translate }}</div>
            }

            <div class="limits-actions">
              @if (limitsFormRef?.form && !limitsFormRef.form.pristine) {
                <app-ui-button
                  variant="ghost"
                  type="button"
                  [disabled]="savingLimits"
                  (click)="resetLimits()"
                >
                  <i class="ri-eraser-line ui-button__icon" aria-hidden="true"></i>
                  {{ 'common.reset' | translate }}
                </app-ui-button>
              }
              <app-ui-button
                type="button"
                [disabled]="savingLimits || !limitsFormRef?.form || limitsFormRef.form.pristine || limitsFormRef.form.invalid"
                (click)="saveLimits()"
              >
                <i class="ri-save-3-line ui-button__icon" aria-hidden="true"></i>
                {{ savingLimits ? ('common.saving' | translate) : ('common.save' | translate) }}
              </app-ui-button>
            </div>
          </div>
        </div>
      } @else {
        <div class="wallet">
          <div class="balance">
            <app-ui-skeleton width="90px" height="11px"></app-ui-skeleton>
            <app-ui-skeleton width="180px" height="22px"></app-ui-skeleton>
          </div>

          <div class="limits">
            <div class="detail-row">
              <div class="form-field">
                <app-ui-skeleton width="110px" height="11px"></app-ui-skeleton>
                <app-ui-skeleton height="40px" radius="12px"></app-ui-skeleton>
              </div>
              <div class="form-field">
                <app-ui-skeleton width="120px" height="11px"></app-ui-skeleton>
                <app-ui-skeleton height="40px" radius="12px"></app-ui-skeleton>
              </div>
            </div>
            <div class="limits-actions">
              <app-ui-skeleton width="110px" height="34px" radius="12px"></app-ui-skeleton>
              <app-ui-skeleton width="110px" height="34px" radius="12px"></app-ui-skeleton>
            </div>
          </div>
        </div>
      }
    </div>

    <div class="card">
      <div class="card-title">{{ 'transactions.filters' | translate }}</div>
      <div class="filters-form">
        @if (showTxSkeleton) {
          <div class="filters-form__skeleton">
            <div class="filters-grid-skeleton">
            
              @for (i of [1,2,3,4]; track i) {
                <div class="form-field">
                  <app-ui-skeleton height="12px" width="120px"></app-ui-skeleton>
                  <app-ui-skeleton height="42px" radius="14px"></app-ui-skeleton>
                </div>
              }
              <div class="form-field wide">
                <app-ui-skeleton width="90px" height="11px"></app-ui-skeleton>
                <app-ui-skeleton height="40px" radius="12px"></app-ui-skeleton>
              </div>
            </div>

            <div class="filters-actions">
              <app-ui-skeleton width="110px" height="32px" radius="12px"></app-ui-skeleton>
            </div>
          </div>
        }

        <div class="filters-form__content" [class.filters-form__content--loading]="showTxSkeleton">
          <app-ui-form
            #txFiltersFormRef
            [fields]="txFilterFields"
            [initialValue]="txFilterInitialValue"
            [showSubmit]="false"
            formClass="filters-grid"
          ></app-ui-form>

          <div class="filters-actions">
            <app-ui-button variant="ghost" type="button" (click)="clearTxFilters()" [disabled]="txFiltersFormRef.form.pristine">
              <i class="ri-filter-off-line ui-button__icon" aria-hidden="true"></i>
              {{ 'common.clear' | translate }}
            </app-ui-button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <app-ui-table
    [columns]="txColumns"
    [data]="(txData$ | async) ?? []"
    [loading]="(loadingTx$ | async) ?? false"
    [page]="txPage"
    [pageSize]="txPageSize"
    [total]="(txTotal$ | async) ?? 0"
    rowActionLabelKey="common.inspect"
    (pageChange)="onTxPageChange($event)"
    (rowAction)="null"
  />

  <app-ui-confirm-dialog
    [open]="deleteModalOpen"
    titleKey="customers.deleteTitle"
    messageKey="customers.deleteConfirm"
    [messageParams]="{ name: customer?.name ?? '' }"
    confirmLabelKey="common.delete"
    cancelLabelKey="common.cancel"
    [loading]="deletingCustomer"
    (confirm)="confirmDelete()"
    (cancel)="closeDelete()"
  ></app-ui-confirm-dialog>
</div>
